; Patient Safety Monitor - Supervisor Configuration
; Manages multiple processes within a single Docker container
; =============================================================================

[supervisord]
nodaemon=true
user=root
logfile=/app/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=3
loglevel=info
pidfile=/var/run/supervisord.pid
childlogdir=/app/logs

; =============================================================================
; Unix Socket for supervisorctl
; =============================================================================
[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

; =============================================================================
; Web Application (FastAPI/Uvicorn)
; =============================================================================
[program:app]
command=uvicorn admin.main:app --host 0.0.0.0 --port 8000 --workers 2
directory=/app
user=appuser
autostart=true
autorestart=true
startretries=5
startsecs=10
stopwaitsecs=30
stopasgroup=true
killasgroup=true

; Logging
stdout_logfile=/app/logs/app.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/app-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3

; Environment
environment=PYTHONUNBUFFERED=1,PYTHONPATH=/app

; =============================================================================
; Background Scheduler (APScheduler)
; =============================================================================
[program:scheduler]
command=python -m scrapers.scheduler
directory=/app
user=appuser
autostart=true
autorestart=true
startretries=5
startsecs=5
stopwaitsecs=60
stopasgroup=true
killasgroup=true

; Logging
stdout_logfile=/app/logs/scheduler.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/scheduler-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3

; Environment
environment=PYTHONUNBUFFERED=1,PYTHONPATH=/app

; =============================================================================
; Process Groups
; =============================================================================
[group:psm]
programs=app,scheduler
priority=999

; =============================================================================
; Event Listeners (Optional - for monitoring)
; =============================================================================
[eventlistener:process_exit]
command=python -c "import sys; from supervisor import childutils; while True: hdrs, payload = childutils.listener.wait(sys.stdin, sys.stdout); childutils.listener.ok(sys.stdout)"
events=PROCESS_STATE_EXITED,PROCESS_STATE_FATAL
autorestart=true
startretries=3
