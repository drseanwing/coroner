{% extends "base.html" %}

{% block title %}{{ post.title }} | {{ site.title }}{% endblock %}
{% block description %}{{ post.excerpt or post.title }}{% endblock %}

{% block og_title %}{{ post.title }}{% endblock %}
{% block og_description %}{{ post.excerpt or site.description }}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_url %}{{ site.base_url }}/posts/{{ post.slug }}/{% endblock %}
{% block canonical %}{{ site.base_url }}/posts/{{ post.slug }}/{% endblock %}

{% block head_extra %}
<meta property="article:published_time" content="{{ post.published_at.isoformat() if post.published_at else post.created_at.isoformat() }}">
{% for tag in post.tags or [] %}
<meta property="article:tag" content="{{ tag }}">
{% endfor %}
{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "{{ post.title | e }}",
    "description": "{{ (post.excerpt or '') | e }}",
    "datePublished": "{{ post.published_at.isoformat() if post.published_at else post.created_at.isoformat() }}",
    "author": {
        "@type": "Organization",
        "name": "{{ site.author }}"
    },
    "publisher": {
        "@type": "Organization",
        "name": "{{ site.title }}",
        "url": "{{ site.base_url }}"
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "{{ site.base_url }}/posts/{{ post.slug }}/"
    }
}
</script>
{% endblock %}

{% block content %}
<article class="max-w-4xl mx-auto px-4 py-8">
    <!-- Header -->
    <header class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 leading-tight">
            {{ post.title }}
        </h1>
        
        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 mb-4">
            <time datetime="{{ post.published_at.isoformat() if post.published_at else '' }}">
                {{ post.published_at | datetime if post.published_at else 'Unpublished' }}
            </time>
            
            {% if finding %}
            <span class="text-gray-400">•</span>
            <span>Source: {{ finding.source.name if finding.source else 'Unknown' }}</span>
            {% endif %}
            
            {% if analysis and analysis.settings %}
            <span class="text-gray-400">•</span>
            <span>{{ analysis.settings | join(', ') }}</span>
            {% endif %}
        </div>
        
        <!-- Tags -->
        {% if post.tags %}
        <div class="flex flex-wrap gap-2">
            {% for tag in post.tags %}
            <a href="/tags/{{ tag | lower | replace(' ', '-') }}/" 
               class="inline-block px-3 py-1 text-sm bg-redi-light-teal text-redi-navy rounded-full hover:bg-teal-300 transition-colors">
                {{ tag }}
            </a>
            {% endfor %}
        </div>
        {% endif %}
    </header>
    
    <!-- Key Learnings Box -->
    {% if analysis and analysis.key_learnings %}
    <aside class="bg-amber-50 border-l-4 border-amber-400 p-6 rounded-r-lg mb-8">
        <h2 class="text-lg font-semibold text-amber-800 mb-3 flex items-center">
            <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            Key Learnings
        </h2>
        <ul class="space-y-2">
            {% for learning in analysis.key_learnings %}
            <li class="flex items-start">
                <svg class="h-5 w-5 text-amber-600 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span class="text-amber-900">{{ learning }}</span>
            </li>
            {% endfor %}
        </ul>
    </aside>
    {% endif %}
    
    <!-- Main Content -->
    <div class="prose prose-lg max-w-none mb-12">
        {{ content_html | safe }}
    </div>
    
    <!-- Human Factors Analysis -->
    {% if analysis and analysis.human_factors %}
    <section class="bg-gray-50 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
            <svg class="h-6 w-6 mr-2 text-redi-coral" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
            Human Factors Analysis (SEIPS 2.0)
        </h2>
        
        <div class="grid md:grid-cols-2 gap-4">
            {% set hf = analysis.human_factors %}
            
            {% if hf.individual_factors %}
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <h3 class="font-semibold text-red-700 mb-2 flex items-center">
                    <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                    Individual Factors
                </h3>
                <ul class="text-sm text-gray-700 space-y-1">
                    {% for factor in hf.individual_factors %}
                    <li>• {{ factor.factor }}: {{ factor.description | truncate(100) }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            {% if hf.team_factors %}
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <h3 class="font-semibold text-orange-700 mb-2 flex items-center">
                    <span class="w-2 h-2 bg-orange-500 rounded-full mr-2"></span>
                    Team Factors
                </h3>
                <ul class="text-sm text-gray-700 space-y-1">
                    {% for factor in hf.team_factors %}
                    <li>• {{ factor.factor }}: {{ factor.description | truncate(100) }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            {% if hf.task_factors %}
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <h3 class="font-semibold text-yellow-700 mb-2 flex items-center">
                    <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                    Task Factors
                </h3>
                <ul class="text-sm text-gray-700 space-y-1">
                    {% for factor in hf.task_factors %}
                    <li>• {{ factor.factor }}: {{ factor.description | truncate(100) }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            {% if hf.technology_factors or hf.environment_factors %}
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <h3 class="font-semibold text-green-700 mb-2 flex items-center">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                    Environment & Technology
                </h3>
                <ul class="text-sm text-gray-700 space-y-1">
                    {% for factor in hf.technology_factors or [] %}
                    <li>• {{ factor.factor }}: {{ factor.description | truncate(100) }}</li>
                    {% endfor %}
                    {% for factor in hf.environment_factors or [] %}
                    <li>• {{ factor.factor }}: {{ factor.description | truncate(100) }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            {% if hf.organisational_factors %}
            <div class="bg-white rounded-lg p-4 shadow-sm md:col-span-2">
                <h3 class="font-semibold text-purple-700 mb-2 flex items-center">
                    <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>
                    Organisational Factors
                </h3>
                <ul class="text-sm text-gray-700 space-y-1">
                    {% for factor in hf.organisational_factors %}
                    <li>• {{ factor.factor }}: {{ factor.description | truncate(100) }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </section>
    {% endif %}
    
    <!-- Source Information -->
    {% if finding %}
    <section class="border-t border-gray-200 pt-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Source Information</h2>
        <dl class="grid grid-cols-2 gap-4 text-sm">
            {% if finding.source %}
            <div>
                <dt class="text-gray-500">Source</dt>
                <dd class="font-medium">{{ finding.source.name }}</dd>
            </div>
            {% endif %}
            
            {% if finding.date_of_finding %}
            <div>
                <dt class="text-gray-500">Date Published</dt>
                <dd class="font-medium">{{ finding.date_of_finding | datetime }}</dd>
            </div>
            {% endif %}
            
            {% if finding.coroner_name %}
            <div>
                <dt class="text-gray-500">Coroner/Investigator</dt>
                <dd class="font-medium">{{ finding.coroner_name }}</dd>
            </div>
            {% endif %}
            
            {% if finding.source_url %}
            <div class="col-span-2">
                <dt class="text-gray-500">Original Document</dt>
                <dd>
                    <a href="{{ finding.source_url }}" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="text-redi-coral hover:text-redi-navy inline-flex items-center">
                        View Original
                        <svg class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                    </a>
                </dd>
            </div>
            {% endif %}
        </dl>
    </section>
    {% endif %}
    
    <!-- Disclaimer -->
    <aside class="mt-8 p-4 bg-gray-100 rounded-lg text-sm text-gray-600">
        <p>
            <strong>Disclaimer:</strong> This summary is derived from publicly available coronial findings 
            and is intended for educational purposes only. It should not be used as a substitute for 
            professional medical or legal advice. The analysis reflects the AI's interpretation of 
            the source material and may not capture all nuances of the original investigation.
        </p>
    </aside>
    
    <!-- Navigation -->
    <nav class="mt-8 pt-8 border-t border-gray-200">
        <div class="flex justify-between">
            <a href="/posts/" class="text-redi-coral hover:text-redi-navy inline-flex items-center">
                <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                All Posts
            </a>
        </div>
    </nav>
</article>
{% endblock %}
